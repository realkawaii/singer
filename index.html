<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邱老師手寫診斷</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f5f3f0; }
        #status { padding: 15px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #ccc; background: white; }
        .success { color: green; border-color: green; }
        .error { color: red; border-color: red; }
        canvas { border: 2px solid #333; background: white; touch-action: none; width: 100%; max-width: 400px; height: 300px; }
    </style>
</head>
<body>

    <h2>雲端連線測試</h2>
    <div id="status">正在檢查網路與 Firebase 載入狀態...</div>
    
    <canvas id="testCanvas"></canvas>
    <br><br>
    <button id="saveBtn" style="padding: 10px 20px;">點我測試儲存</button>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        const statusDiv = document.getElementById('status');
        
        // 1. 檢查 Firebase 是否載入成功
        if (typeof firebase === 'undefined') {
            statusDiv.innerHTML = "❌ <b>錯誤：無法載入 Firebase 程式庫。</b><br>這通常是網路擋住了 gstatic.com，或是您目前沒有連上網路。";
            statusDiv.className = "error";
        } else {
            statusDiv.innerHTML = "⏳ Firebase 載入成功，正在嘗試連線資料庫...";
            
            const firebaseConfig = {
                apiKey: "AIzaSyDtTj8uoMK5l-XPDecE4Yyl_3IFCJB1SdQ",
                authDomain: "singer-9d813.firebaseapp.com",
                projectId: "singer-9d813",
                storageBucket: "singer-9d813.appspot.com",
                messagingSenderId: "550661805021",
                appId: "1:550661805021:web:1f61bc3bada3e07dcd5c34"
            };

            try {
                // 初始化
                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();
                
                // 測試讀取
                db.collection("handwriting_notes").limit(1).get().then(() => {
                    statusDiv.innerHTML = "✅ <b>連線完全正常！</b><br>資料庫已就緒。請嘗試畫圖並點擊儲存按鈕。";
                    statusDiv.className = "success";
                }).catch((err) => {
                    statusDiv.innerHTML = "❌ <b>資料庫連線失敗</b><br>原因：" + err.message;
                    statusDiv.className = "error";
                });

                // 基礎畫布邏輯
                const canvas = document.getElementById('testCanvas');
                const ctx = canvas.getContext('2d');
                let drawing = false;
                ctx.lineWidth = 3;

                canvas.onmousedown = () => { drawing = true; ctx.beginPath(); };
                canvas.onmousemove = (e) => { if(!drawing) return; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); };
                window.onmouseup = () => drawing = false;

                // 儲存測試
                document.getElementById('saveBtn').onclick = async () => {
                    const data = canvas.toDataURL();
                    try {
                        await db.collection("handwriting_notes").add({
                            data: data,
                            time: new Date().toLocaleString(),
                            createdAt: Date.now()
                        });
                        alert("儲存成功！請檢查另一台設備。");
                    } catch (e) {
                        alert("儲存出錯：" + e.message);
                    }
                };

            } catch (e) {
                statusDiv.innerHTML = "❌ 初始化過程出錯：" + e.message;
            }
        }
    </script>
</body>
</html>
