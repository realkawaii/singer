<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>手寫記事 - 無印風</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --muji-beige: #f5f3f0;
            --muji-charcoal: #333333;
            --muji-stone: #e0dbd5;
            --muji-white: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--muji-beige);
            color: var(--muji-charcoal);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            padding: 15px;
            background: var(--muji-white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--muji-stone);
            z-index: 10;
        }

        .header h2 { margin: 0; font-size: 18px; font-weight: 500; }

        #canvas-wrap {
            flex: 1;
            position: relative;
            background: var(--muji-white);
            margin: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        canvas {
            display: block;
            touch-action: none;
            background-color: #ffffff; /* 確保輸出時背景是白色 */
        }

        .btn-group { display: flex; gap: 8px; }
        button {
            border: 1px solid var(--muji-stone);
            background: var(--muji-white);
            color: var(--muji-charcoal);
            padding: 8px 12px;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
        }
        button.save { background: var(--muji-charcoal); color: var(--muji-white); border: none; }
        button:active { opacity: 0.6; }

        #history {
            padding: 15px;
            background: var(--muji-beige);
            padding-bottom: 50px;
        }

        .record-card {
            background: var(--muji-white);
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid var(--muji-stone);
        }

        .record-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .record-card img {
            width: 100px;
            height: auto;
            border: 1px solid var(--muji-beige);
            background: #fff;
        }

        .info { flex: 1; }
        .time-label { font-size: 12px; color: #888; display: block; margin-bottom: 4px; }
        
        .card-actions {
            border-top: 1px solid var(--muji-beige);
            padding-top: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .action-link { font-size: 13px; text-decoration: underline; background: none; border: none; padding: 0; cursor: pointer; }
        .edit-link { color: #556b2f; }
        .del-link { color: #a52a2a; }
        .download-link { color: #007bff; }
    </style>
</head>
<body>

    <div class="header">
        <h2>手寫記事</h2>
        <div class="btn-group">
            <button onclick="clearCanvas()">清空</button>
            <button class="save" onclick="saveDrawing()">儲存紀錄</button>
        </div>
    </div>

    <div id="canvas-wrap">
        <canvas id="mainCanvas"></canvas>
    </div>

    <div id="history">
        <h3 style="font-size: 16px; font-weight: 500; border-left: 3px solid var(--muji-charcoal); padding-left: 10px;">歷史紀錄</h3>
        <div id="recordList"></div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const wrap = document.getElementById('canvas-wrap');
        const recordList = document.getElementById('recordList');
        
        let isDrawing = false;
        let editIndex = null;

        function resizeCanvas() {
            // 暫存目前的畫布內容
            const tempImage = canvas.toDataURL();
            canvas.width = wrap.clientWidth;
            canvas.height = wrap.clientHeight;
            
            // 重新設定樣式
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#333';
            
            // 如果是在編輯中或原本有東西，繪製回白色背景
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 載入回之前的圖案（若有）
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = tempImage;
        }

        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            if(e.touches) e.preventDefault();
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            if(e.touches) e.preventDefault();
        }

        function stopDrawing() { isDrawing = false; }

        canvas.addEventListener('touchstart', startDrawing, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stopDrawing);

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            editIndex = null;
        }

        function saveDrawing() {
            const dataURL = canvas.toDataURL("image/png");
            const now = new Date();
            const timeString = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            let saved = JSON.parse(localStorage.getItem('my_drawings_v2') || '[]');

            if (editIndex !== null) {
                saved[editIndex].data = dataURL;
                saved[editIndex].time = timeString + " (已編輯)";
                editIndex = null;
            } else {
                saved.unshift({ data: dataURL, time: timeString });
            }

            localStorage.setItem('my_drawings_v2', JSON.stringify(saved));
            clearCanvas();
            renderRecords();
        }

        function renderRecords() {
            recordList.innerHTML = '';
            const saved = JSON.parse(localStorage.getItem('my_drawings_v2') || '[]');

            saved.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'record-card';
                card.innerHTML = `
                    <div class="record-content">
                        <img src="${item.data}">
                        <div class="info">
                            <span class="time-label">${item.time}</span>
                            <div style="font-size: 14px;">手寫紀錄</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-link download-link" onclick="exportImage('${item.data}', '${item.time}')">輸出圖片</button>
                        <button class="action-link edit-link" onclick="editRecord(${index})">編輯</button>
                        <button class="action-link del-link" onclick="deleteRecord(${index})">刪除</button>
                    </div>
                `;
                recordList.appendChild(card);
            });
        }

        // 輸出並儲存圖片
        function exportImage(dataURL, time) {
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = `手寫紀錄_${time.replace(/[\/ :]/g, '_')}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 針對某些行動裝置瀏覽器的提示
            alert("圖片已嘗試輸出。若未自動下載，請在開啟的圖片上長按並選擇「儲存圖片」。");
        }

        function deleteRecord(index) {
            if(!confirm("確定要刪除這份紀錄嗎？")) return;
            let saved = JSON.parse(localStorage.getItem('my_drawings_v2') || '[]');
            saved.splice(index, 1);
            localStorage.setItem('my_drawings_v2', JSON.stringify(saved));
            renderRecords();
        }

        function editRecord(index) {
            const saved = JSON.parse(localStorage.getItem('my_drawings_v2') || '[]');
            const img = new Image();
            img.onload = function() {
                clearCanvas();
                ctx.drawImage(img, 0, 0);
                editIndex = index;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            img.src = saved[index].data;
        }

        // 初始化
        renderRecords();
    </script>
</body>
</html>
